# -*- coding: UTF-8 -*-
from pyspark.sql import *
from pyspark.sql.types import *
from pyspark.sql.functions import pandas_udf, PandasUDFType, udf, unix_timestamp, expr, from_unixtime
from math import *
import pandas as pd
import csv



# use udf to withColumn to return internal of time
# 定义用于计算两个timestamp之间相差多少秒的函数
def internaltime(start,end):
    return (end - start).total_seconds()

# 计算两个个gps点之间的距离
def getdistance(lng1,lat1,lng2,lat2):
    lng1, lat1, lng2, lat2 = map(radians, [lng1, lat1, lng2, lat2])
    dlon=lng2-lng1
    dlat=lat2-lat1
    a=sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    dis = 2 * asin(sqrt(a)) * 6371 * 1000
    return dis

# 计算每秒的速度
def getSpeed(distance,sec):
    return (distance/sec)*3.6

# 计算一个trip的驾驶时长
def getDurationOfTrip(start,end):
    totalSecond = end - start
    m, s = divmod(totalSecond, 60)
    h, m = divmod(m, 60)
    result = ""
    if(h != 0):
        result += (str(h) + "hour")
    if(m != 0):
        result += (str(m) + "minute")
    if(s != 0):
        result += (str(s) + "second")
    return result

if __name__ == '__main__':
    # 程序入口
    spark = SparkSession \
        .builder \
        .appName("StructuredReadCSV") \
        .config("spark.debug.maxToStringFields", "100") \
        .getOrCreate()

    # 定义读入csv文件时每个字段的数据类型
    gpsPositionSchema = StructType().add("postId",LongType(),True) \
        .add("id", "string") \
        .add(StructField("longitude",DoubleType(),True)) \
        .add(StructField("latitude",DoubleType(),True)) \
        .add(StructField("altitude",DoubleType(),True)) \
        .add("time",TimestampType(),True)
    # 读入数据
    lines = spark \
        .readStream \
        .option("sep", ",") \
        .schema(gpsPositionSchema) \
        .csv("file:///D:/Carson/testdata/csvdata")  # /data/carsontest/csv  file:///D:/Carson/testdata/csv

    # 将自定义函数注册到spark应用程序中
    timeDifferent=udf(internaltime, DoubleType())
    gpsDiff=udf(getdistance,DoubleType())
    getSpe=udf(getSpeed, DoubleType())
    getDuration=udf(getDurationOfTrip, StringType())

    # 给每一条gps记录添加一列unix_timestamp，并利用id和unix_timestamp来去重，达到只取每秒中的第一条gps记录的效果
    lines = lines \
        .withColumn("newtime",unix_timestamp(lines.time,'yyyy-MM-dd HH:mm:ss')) \
        .dropDuplicates(["id","newtime"])

    # 连接两个表格，用于计算两个gps之间的距离，速度，时间，因为数据是分布式读取的，所以需要关联两个gps的联系
    rightData = lines.alias("rightData")
    leftData = lines.toDF("lpostId","lid","llongitude","llatitude","laltitude","ltime","lnewtime")

    # 计算gps间隔，距离，每秒速度
    result = rightData.join(leftData,expr("id=lid and lnewtime-newtime=1")) \
        .withColumn("seconds", timeDifferent(rightData.time,leftData.ltime)) \
        .withColumn("distance",gpsDiff(rightData.longitude,rightData.latitude,leftData.llongitude,leftData.llatitude))
    result = result.withColumn("speed",getSpe(result.distance,result.seconds))

    # 添加限速列 先用speed来填充speedLimit 后面再改成真正的speedLimit
    result = result.withColumn("speedLimit",result.speed)

    # calculate speedLimit
    #类似声明函数
    @pandas_udf("id string,longitude double,latitude double,altitude double, time timestamp, speed double, speedLimit double", PandasUDFType.GROUPED_MAP)
    def calculateSpeedLimit(pdf):
        # 下面的编程使用python语法，与spark api没有太大的关联，在这改变算法，不会影响spark计算逻辑
        # 现在将限速点写死在程序中，且只对一个trip有效，后续该井可以改成从数据库中查询得到
        limitPoint = ['113.373455,23.150707,40,[]','113.373532,23.150454,40,[]','113.373535,23.150183,40,[]','113.373547,23.149917,40,[]','113.373457,23.149824,40,[]','113.373264,23.150011,40,[]','113.372981,23.149998,50,科韵路','113.372935,23.149756,50,科韵路','113.372949,23.149488,50,科韵路','113.372963,23.149221,50,科韵路','113.372977,23.148953,50,科韵路','113.372978,23.148683,50,科韵路','113.372978,23.148413,50,科韵路','113.372942,23.148151,50,科韵路','113.372903,23.147889,50,科韵路','113.372863,23.147627,50,科韵路','113.372773,23.147379,50,科韵路','113.372674,23.147134,50,科韵路','113.372573,23.146886,50,科韵路','113.372474,23.146642,50,科韵路','113.372384,23.146392,50,科韵路','113.372303,23.14614,50,科韵路','113.372222,23.145889,50,科韵路','113.37214,23.145639,50,科韵路','113.372065,23.145387,50,科韵路','113.372001,23.145131,50,科韵路','113.37194,23.144876,50,科韵路','113.371877,23.144621,50,科韵路','113.371825,23.144363,50,科韵路','113.371722,23.144119,40,广园快速路入口','113.371567,23.143897,40,广园快速路入口','113.371371,23.143705,40,广园快速路入口','113.371225,23.143475,40,广园快速路入口','113.371144,23.143223,40,广园快速路入口','113.371139,23.142956,40,广园快速路入口','113.371148,23.142687,40,广园快速路入口','113.371105,23.142427,40,广园快速路入口','113.370952,23.142204,40,广园快速路入口','113.370718,23.142053,40,广园快速路入口','113.37044,23.142002,40,广园快速路入口','113.370154,23.142031,40,广园快速路入口','113.369872,23.142071,40,广园快速路入口','113.369589,23.142109,80,广园快速路','113.369309,23.142162,80,广园快速路','113.369049,23.142271,80,广园快速路','113.368787,23.142375,80,广园快速路','113.368526,23.142479,80,广园快速路','113.368265,23.142583,80,广园快速路','113.368004,23.142687,80,广园快速路','113.367743,23.142794,80,广园快速路','113.367482,23.142901,80,广园快速路','113.367221,23.143008,80,广园快速路','113.366961,23.143115,80,广园快速路','113.3667,23.143222,80,广园快速路','113.366439,23.143329,80,广园快速路','113.366178,23.143436,80,广园快速路','113.365917,23.143542,80,广园快速路','113.365658,23.143649,80,广园快速路','113.365397,23.143756,80,广园快速路','113.365136,23.143862,80,广园快速路','113.364876,23.143969,80,广园快速路','113.364616,23.144076,80,广园快速路','113.364356,23.144183,80,广园快速路','113.364095,23.144289,80,广园快速路','113.363834,23.144396,80,广园快速路','113.363575,23.144503,80,广园快速路','113.363316,23.144611,80,广园快速路','113.363056,23.144722,80,广园快速路','113.362798,23.144832,80,广园快速路','113.362536,23.144937,80,广园快速路','113.362275,23.14504,80,广园快速路','113.362012,23.14514,80,广园快速路','113.361745,23.145229,80,广园快速路','113.361478,23.145318,80,广园快速路','113.361211,23.145403,80,广园快速路','113.360941,23.145484,80,广园快速路','113.360672,23.145566,80,广园快速路','113.360402,23.145647,80,广园快速路','113.360133,23.145729,80,广园快速路','113.359864,23.14581,80,广园快速路','113.359596,23.145891,80,广园快速路','113.359327,23.145973,80,广园快速路','113.359057,23.146054,80,广园快速路','113.358786,23.146137,80,广园快速路','113.358515,23.146219,80,广园快速路','113.358245,23.1463,80,广园快速路','113.357976,23.146382,80,广园快速路','113.357707,23.146463,80,广园快速路','113.357439,23.146546,80,广园快速路','113.357169,23.146627,80,广园快速路','113.356897,23.146701,80,广园快速路','113.356624,23.146774,80,广园快速路','113.356352,23.146848,80,广园快速路','113.356079,23.146921,80,广园快速路','113.35581,23.147002,80,广园快速路','113.35554,23.147083,80,广园快速路','113.355271,23.147163,80,广园快速路','113.355002,23.147244,80,广园快速路','113.35473,23.147325,80,广园快速路','113.354456,23.147397,80,广园快速路','113.354182,23.147463,80,广园快速路','113.353908,23.147534,80,广园快速路','113.353632,23.147596,80,广园快速路','113.353353,23.147649,80,广园快速路','113.353074,23.147698,80,广园快速路','113.352794,23.147746,80,广园快速路','113.352507,23.147775,80,广园快速路','113.352219,23.1478,80,广园快速路','113.351929,23.147812,80,广园快速路','113.351638,23.147823,80,广园快速路','113.351347,23.147828,80,广园快速路','113.351054,23.147821,80,广园快速路','113.350762,23.147814,80,广园快速路','113.350473,23.147796,80,广园快速路','113.350185,23.147776,80,广园快速路','113.349896,23.147755,80,广园快速路','113.349608,23.147735,80,广园快速路','113.34932,23.147715,80,广园快速路','113.349031,23.147694,80,广园快速路','113.348743,23.147674,80,广园快速路','113.348454,23.147654,80,广园快速路','113.348166,23.147634,80,广园快速路','113.347878,23.147613,80,广园快速路','113.347589,23.147593,80,广园快速路','113.347301,23.147573,80,广园快速路','113.347013,23.147552,80,广园快速路','113.346724,23.147532,80,广园快速路','113.346434,23.147514,80,广园快速路','113.346145,23.147498,80,广园快速路','113.345855,23.147482,80,广园快速路','113.345565,23.14747,80,广园快速路','113.345272,23.147464,80,广园快速路','113.344979,23.147458,80,广园快速路','113.344686,23.147459,80,广园快速路','113.344392,23.147464,80,广园快速路','113.3441,23.147472,80,广园快速路','113.34381,23.147485,80,广园快速路','113.34352,23.147498,80,广园快速路','113.343233,23.147523,80,广园快速路','113.342947,23.147554,80,广园快速路','113.342662,23.147584,80,广园快速路','113.342377,23.147614,80,广园快速路','113.342093,23.14765,80,广园快速路','113.341811,23.147689,80,广园快速路','113.341527,23.147728,80,广园快速路','113.341245,23.147775,80,广园快速路','113.340964,23.147821,80,广园快速路','113.340684,23.147867,80,广园快速路','113.340403,23.147914,80,广园快速路','113.340122,23.14796,80,广园快速路','113.339842,23.148007,80,广园快速路','113.339561,23.148053,80,广园快速路','113.33928,23.1481,80,广园快速路','113.338999,23.148147,80,广园快速路','113.338719,23.148195,80,广园快速路','113.33844,23.148245,80,广园快速路','113.338161,23.148296,80,广园快速路','113.337882,23.148353,80,广园快速路','113.33761,23.148427,80,广园快速路','113.337339,23.148501,80,广园快速路','113.337069,23.148583,80,广园快速路','113.3368,23.148669,80,广园快速路','113.336533,23.148754,80,广园快速路','113.336264,23.148839,80,广园快速路','113.335996,23.148926,80,广园快速路','113.33573,23.149015,80,广园快速路','113.335462,23.149104,80,广园快速路','113.335194,23.149193,80,广园快速路','113.334927,23.14928,80,广园快速路','113.33466,23.149367,80,广园快速路','113.334392,23.149454,80,广园快速路','113.334125,23.149541,80,广园快速路','113.333858,23.149628,80,广园快速路','113.33359,23.149714,80,广园快速路','113.333322,23.149799,80,广园快速路','113.333053,23.149883,80,广园快速路','113.332784,23.149968,80,广园快速路','113.332516,23.150053,80,广园快速路','113.332247,23.150138,80,广园快速路','113.331978,23.150221,80,广园快速路','113.331709,23.150305,80,广园快速路','113.331439,23.150388,80,广园快速路','113.33117,23.150472,80,广园快速路','113.330901,23.150555,80,广园快速路','113.330633,23.150638,80,广园快速路','113.330364,23.150723,80,广园快速路','113.330096,23.150809,80,广园快速路','113.329829,23.150897,80,广园快速路','113.329561,23.150984,80,广园快速路','113.329294,23.151071,80,广园快速路','113.329027,23.151157,80,广园快速路','113.328759,23.151244,80,广园快速路','113.328492,23.15133,80,广园快速路','113.328225,23.151417,80,广园快速路','113.327956,23.151504,80,广园快速路','113.327689,23.151591,80,广园快速路','113.327422,23.151677,80,广园快速路','113.327155,23.151764,80,广园快速路','113.326887,23.15185,80,广园快速路','113.32662,23.151937,80,广园快速路','113.326353,23.152027,80,广园快速路','113.326088,23.152119,80,广园快速路','113.325822,23.152211,80,广园快速路','113.32557,23.152328,80,广园快速路','113.32532,23.152453,80,广园快速路','113.32506,23.152562,80,广园快速路','113.324803,23.152675,80,广园快速路','113.324547,23.152792,80,广园快速路','113.324291,23.152909,80,广园快速路','113.324035,23.153027,80,广园快速路','113.323777,23.153142,80,广园快速路','113.323515,23.153245,80,广园快速路','113.323267,23.153379,80,广园快速路','113.323018,23.153513,80,广园快速路','113.322769,23.153647,80,广园快速路','113.322521,23.153781,80,广园快速路','113.322272,23.153918,80,广园快速路','113.322024,23.154052,80,广园快速路','113.321774,23.154183,80,广园快速路','113.321526,23.154318,80,广园快速路','113.321277,23.154453,80,广园快速路','113.321028,23.154588,80,广园快速路','113.32078,23.154723,80,广园快速路','113.320531,23.154858,80,广园快速路','113.320282,23.154993,80,广园快速路','113.320035,23.155132,80,广园快速路','113.319789,23.155271,80,广园快速路','113.319543,23.15541,80,广园快速路','113.319296,23.155549,80,广园快速路','113.319055,23.155698,80,广园快速路','113.318825,23.155859,80,广园快速路','113.318601,23.156027,80,广园快速路','113.318381,23.156198,80,广园快速路','113.318161,23.156368,80,广园快速路','113.317941,23.156539,80,广园快速路','113.31772,23.15671,80,广园快速路','113.317481,23.156862,80,广园快速路','113.317233,23.157001,80,广园快速路','113.316975,23.157115,80,广园快速路','113.316701,23.157185,80,广园快速路','113.316422,23.157234,80,广园快速路','113.316135,23.157255,80,广园快速路','113.315845,23.157238,80,广园快速路','113.315567,23.157179,80,广园快速路','113.315293,23.157109,80,广园快速路','113.31504,23.156987,80,广园快速路','113.314785,23.156868,80,广园快速路','113.314528,23.156751,80,广园快速路','113.31427,23.156637,80,广园东路','113.314012,23.156522,80,广园东路','113.313754,23.156408,80,广园东路','113.313495,23.156293,80,广园东路','113.313237,23.156179,80,广园东路','113.312972,23.156081,80,广园东路','113.312699,23.156009,80,广园东路','113.312419,23.155963,80,广园东路','113.312132,23.155939,80,广园东路','113.311843,23.155945,80,广园东路','113.31156,23.155982,80,广园东路','113.311278,23.156025,80,广园东路','113.310995,23.156069,80,广园东路','113.310713,23.156112,80,广园东路','113.310433,23.156161,80,广园东路','113.310154,23.156212,80,广园东路','113.309876,23.156271,80,广园东路','113.309601,23.156336,80,广园东路','113.309331,23.156414,80,广园东路','113.309063,23.1565,80,广园东路','113.308798,23.156596,80,广园东路','113.308538,23.156703,80,广园东路','113.308281,23.156817,80,广园东路','113.308028,23.156941,80,广园东路','113.30778,23.157075,80,广园东路','113.307531,23.157211,80,广园东路','113.307286,23.157351,80,广园东路','113.307058,23.157512,80,广园东路','113.306812,23.157655,50,广园东路辅路','113.306562,23.157786,50,广园东路辅路','113.306312,23.157917,50,广园东路辅路','113.306062,23.158048,40,广园东路出口','113.305814,23.158186,40,广园东路出口','113.305565,23.158325,40,广园东路出口','113.305317,23.158462,40,广园东路出口','113.305067,23.158592,40,广园东路出口','113.304812,23.158712,40,广园东路出口','113.30455,23.158813,40,广园东路出口','113.304278,23.158888,40,广园东路出口','113.303999,23.15894,40,广园东路出口','113.303714,23.158973,40,广园东路出口','113.303422,23.158973,40,广园东路出口','113.303133,23.158954,40,广园东路出口','113.302848,23.158924,40,广园东路出口','113.302571,23.158865,40,广园东路出口','113.302301,23.158787,40,广园东路出口','113.302037,23.158692,40,广园东路出口','113.301776,23.158586,40,广园东路出口','113.301516,23.158479,40,广园东路出口','113.301256,23.158372,40,广园东路出口','113.300995,23.158265,40,广园东路出口','113.300735,23.158158,40,广园东路出口','113.300477,23.158046,40,广园东路出口','113.300218,23.157937,40,广园东路出口','113.299959,23.15783,40,广园东路出口','113.299699,23.157723,40,广园东路出口','113.299438,23.157616,40,广园东路出口','113.299172,23.157524,40,广园东路出口','113.298911,23.157417,40,广园东路出口','113.298655,23.157298,40,广园东路出口','113.298403,23.157172,40,广园东路出口','113.298183,23.157002,40,广园东路出口','113.297989,23.156809,40,广园东路出口','113.297822,23.156592,40,广园东路出口','113.297659,23.156371,40,广园东路出口','113.297498,23.156151,40,广园东路出口','113.297328,23.155938,40,广园东路出口','113.297138,23.155739,40,广园东路出口','113.296937,23.155552,40,广园东路出口','113.296735,23.155366,40,广园东路出口','113.29654,23.155173,40,广园东路出口','113.296352,23.154974,40,广园东路出口','113.296204,23.154747,40,广园东路出口','113.296091,23.154506,40,广园东路出口','113.29598,23.154264,40,广园东路出口','113.295869,23.154022,40,广园东路出口','113.295757,23.15378,40,广园东路出口','113.295646,23.153537,40,广园东路出口','113.295534,23.153295,40,广园东路出口','113.295422,23.153052,40,广园东路出口','113.295311,23.15281,40,广园东路出口','113.295173,23.152576,40,广园东路出口','113.294992,23.152372,40,广园东路出口','113.294811,23.152168,40,广园东路出口','113.29463,23.151964,40,广园东路出口','113.294432,23.151773,40,广园东路出口','113.294233,23.151583,40,广园东路出口','113.294035,23.151393,40,广园东路出口','113.293821,23.151216,40,广园东路出口','113.293606,23.15104,80,内环路','113.293391,23.150864,80,内环路','113.293175,23.15069,80,内环路','113.29296,23.150517,80,内环路','113.292737,23.150349,80,内环路','113.292506,23.150189,80,内环路','113.292275,23.150029,80,内环路','113.292043,23.149869,80,内环路','113.291813,23.149706,80,内环路','113.291585,23.149544,80,内环路','113.291355,23.149383,80,内环路','113.291126,23.149222,80,内环路','113.290896,23.149061,80,内环路','113.290666,23.148901,80,内环路','113.290436,23.14874,80,内环路','113.290205,23.148578,80,内环路','113.289974,23.148417,80,内环路','113.289744,23.148256,80,内环路','113.289512,23.148096,80,内环路','113.28928,23.147937,80,内环路','113.289035,23.147797,80,内环路','113.288786,23.147665,80,内环路','113.288536,23.147531,80,内环路','113.288282,23.14741,80,内环路','113.288027,23.147289,80,内环路','113.287768,23.147179,80,内环路','113.287505,23.147077,80,内环路','113.287241,23.146975,80,内环路','113.286969,23.146899,80,内环路','113.286696,23.146829,80,内环路','113.286418,23.146776,80,内环路','113.286135,23.146735,80,内环路','113.285852,23.146698,80,内环路','113.285566,23.146671,80,内环路','113.285274,23.146663,80,内环路','113.28498,23.14666,80,内环路','113.284686,23.146656,80,内环路','113.284393,23.146652,80,内环路','113.284099,23.146649,80,内环路','113.283806,23.146645,80,内环路','113.283512,23.146641,80,内环路','113.283218,23.146638,80,内环路','113.282925,23.146634,80,内环路','113.282633,23.146628,80,内环路','113.28234,23.146621,80,内环路','113.282047,23.146614,80,内环路','113.281754,23.146607,80,内环路','113.281461,23.1466,80,内环路','113.281169,23.146593,80,内环路','113.280876,23.146585,80,内环路','113.280585,23.146576,80,内环路','113.280293,23.146568,80,内环路','113.280002,23.146559,80,内环路','113.27971,23.146551,80,内环路','113.279416,23.146552,80,内环路','113.279123,23.146554,80,内环路','113.27883,23.146556,80,内环路','113.278536,23.146559,80,内环路','113.278243,23.146561,80,内环路','113.277952,23.14655,80,内环路','113.277675,23.146493,80,内环路','113.277408,23.146404,80,内环路','113.277153,23.146283,80,内环路','113.276935,23.146109,80,内环路','113.276743,23.145912,80,内环路','113.276574,23.145696,80,内环路','113.276404,23.145481,80,内环路','113.27622,23.145279,80,内环路','113.276,23.145109,80,内环路','113.275753,23.144967,80,内环路','113.2755,23.144844,80,内环路','113.275242,23.144731,80,内环路','113.274984,23.144621,80,内环路','113.274724,23.144511,80,内环路','113.274466,23.144401,80,内环路','113.274205,23.144293,80,内环路','113.273943,23.14419,80,内环路','113.273686,23.144082,80,内环路','113.273427,23.143974,80,内环路','113.27317,23.143866,80,内环路','113.272914,23.143752,80,内环路','113.272656,23.14364,80,内环路','113.272398,23.14353,80,内环路','113.272139,23.143419,80,内环路','113.271879,23.143307,80,内环路','113.271621,23.143197,80,内环路','113.271362,23.143086,80,内环路','113.271104,23.142975,80,内环路','113.270846,23.142864,80,内环路','113.270587,23.142754,80,内环路','113.270321,23.14266,80,内环路','113.270049,23.142587,80,内环路','113.269766,23.14255,80,内环路','113.269474,23.142556,80,内环路','113.269192,23.142598,80,内环路','113.268921,23.14267,80,内环路','113.268656,23.142765,80,内环路','113.268392,23.142865,80,内环路','113.268129,23.142966,80,内环路','113.26787,23.143073,80,内环路','113.267615,23.143194,80,内环路','113.267366,23.143326,80,内环路','113.267117,23.143462,80,内环路','113.266868,23.143597,80,内环路','113.266619,23.143732,80,内环路','113.266371,23.143867,80,内环路','113.266122,23.144002,80,内环路','113.265874,23.144137,80,内环路','113.265626,23.144271,80,内环路','113.265377,23.144407,80,内环路','113.265133,23.144549,80,内环路','113.264888,23.144693,80,内环路','113.264644,23.144838,80,内环路','113.264411,23.144993,80,内环路','113.264181,23.145153,80,内环路','113.263952,23.145313,80,内环路','113.263736,23.145487,80,内环路','113.263522,23.145663,80,内环路','113.263307,23.145839,80,内环路','113.263093,23.146015,80,内环路','113.262878,23.146192,80,内环路','113.262663,23.146368,80,内环路','113.262431,23.146528,80,内环路','113.262201,23.146687,80,内环路','113.261963,23.14684,80,内环路','113.261718,23.146983,80,内环路','113.261472,23.147124,80,内环路','113.261214,23.147238,80,内环路','113.260952,23.147338,80,内环路','113.260686,23.147434,80,内环路','113.260417,23.147519,80,内环路','113.260146,23.147593,80,内环路','113.259874,23.147666,80,内环路','113.2596,23.147736,80,内环路','113.259325,23.147802,80,内环路','113.259051,23.147869,80,内环路','113.258777,23.147935,80,内环路','113.258503,23.148001,80,内环路','113.258229,23.148068,80,内环路','113.257954,23.148135,80,内环路','113.257679,23.148203,80,内环路','113.257405,23.148271,80,内环路','113.25713,23.148339,80,内环路','113.256856,23.148407,80,内环路','113.256582,23.148474,80,内环路','113.256307,23.148542,80,内环路','113.256033,23.14861,80,内环路','113.255759,23.148678,80,内环路','113.255493,23.148761,80,内环路','113.25524,23.148873,80,内环路','113.254964,23.148942,40,内环路出口','113.254689,23.14901,40,内环路出口','113.254413,23.149079,40,内环路出口','113.254138,23.149147,40,内环路出口','113.253866,23.149219,40,内环路出口','113.253594,23.149291,40,内环路出口','113.25332,23.149364,50,环市西路','113.253057,23.14946,50,环市西路','113.2528,23.149574,50,环市西路','113.252538,23.149672,50,环市西路','113.252271,23.149765,50,环市西路','113.252012,23.149876,50,环市西路','113.251756,23.149995,50,环市西路','113.251507,23.150129,50,环市西路','113.251255,23.150254,50,环市西路','113.251061,23.150136,50,环市西路','113.2509,23.149915,50,环市西路','113.250722,23.149707,50,环市西路','113.250532,23.14951,50,环市西路','113.250299,23.149352,50,环市西路','113.250065,23.149193,50,环市西路','113.249839,23.149027,50,站前路','113.249617,23.148858,50,站前路','113.249396,23.148688,50,站前路','113.249172,23.148524,50,站前路','113.248914,23.148417,50,站前路','113.248677,23.148261,50,站前路','113.248443,23.148105,50,站前路','113.248208,23.147949,50,站前路','113.247977,23.147789,50,站前路','113.247752,23.147623,50,站前路','113.247526,23.147457,50,站前路','113.247299,23.147291,50,站前路','113.247072,23.147126,50,站前路','113.246846,23.146961,50,站前路','113.246619,23.146796,50,站前路','113.246395,23.14663,50,站前路','113.246172,23.146465,50,站前路','113.245947,23.146299,50,站前路','113.245723,23.146133,50,站前路','113.245499,23.145967,50,站前路','113.245273,23.145802,50,站前路','113.245047,23.145638,50,站前路','113.244823,23.145472,50,站前路','113.244597,23.145305,50,站前路','113.244369,23.145142,50,站前路','113.244148,23.144972,50,站前路','113.243929,23.144799,50,站前路','113.243711,23.144625,50,站前路','113.243494,23.14445,50,站前路','113.243276,23.144276,50,站前路','113.24306,23.144102,50,站前路','113.242843,23.143929,50,站前路','113.242627,23.143754,50,站前路','113.242413,23.143577,50,站前路','113.242198,23.1434,50,站前路','113.241989,23.14322,50,站前路','113.241785,23.143034,50,站前路','113.241588,23.142841,50,站前路','113.241391,23.142649,50,站前路','113.241193,23.142457,50,站前路','113.240996,23.142264,50,站前路','113.240799,23.142072,50,站前路','113.240603,23.141881,50,站前路','113.240405,23.141689,50,站前路','113.240212,23.141493,50,站前路','113.240021,23.141297,50,站前路','113.23983,23.1411,50,站前路','113.239639,23.140903,50,站前路','113.239448,23.140707,50,站前路','113.239253,23.140512,50,站前路','113.23903,23.140343,50,站前路','113.2388,23.140182,50,流花路','113.23857,23.14002,50,流花路','113.23834,23.139859,50,流花路','113.238114,23.139696,50,流花路','113.237885,23.139534,50,流花路','113.237653,23.139375,50,流花路','113.237416,23.13922,50,流花路','113.23718,23.139065,50,流花路','113.236956,23.138898,50,流花路','113.236757,23.13871,40,西华路','113.236604,23.138485,40,西华路','113.236472,23.138251,40,西华路','113.236343,23.138014,40,西华路','113.236217,23.137776,40,西华路','113.236078,23.137557,40,西华路','113.235849,23.137491,40,西华路','113.235932,23.13724,40,西华路','113.236071,23.137007,40,西华路','113.236212,23.136774,40,西华路','113.236098,23.136552,40,西华路','113.23591,23.136354,40,西华路','113.235721,23.136156,40,西华路','113.235515,23.135976,40,西华路','113.235408,23.135745,40,周门北路','113.235349,23.135489,40,周门北路','113.235247,23.135244,40,周门北路','113.235142,23.135001,40,周门北路','113.23503,23.13476,40,周门北路','113.23494,23.134512,40,周门北路','113.23485,23.134264,40,周门北路','113.23476,23.134015,40,周门北路','113.234655,23.133771,40,周门北路','113.234543,23.133528,40,周门北路','113.234416,23.133291,40,周门南路','113.234263,23.133064,40,周门南路','113.234102,23.132844,40,周门南路','113.233931,23.132633,40,周门南路','113.233735,23.132433,40,周门南路','113.23353,23.132245,40,周门南路','113.233322,23.132062,40,周门南路','113.233112,23.131882,40,周门南路','113.232901,23.131703,40,周门南路','113.23269,23.131524,40,周门南路','113.232479,23.131344,40,周门南路','113.232271,23.131163,40,周门南路','113.232063,23.130981,40,周门南路','113.231839,23.130815,40,周门南路','113.23159,23.130679,40,周门南路','113.231327,23.130579,40,周门南路','113.231177,23.130708,40,周门南路','113.231076,23.130954,40,周门南路']
        pdf = pdf.sort_values(by=['time'])
        speedLimit = []

        for line in range(pdf["id"].size):#gps循环
            min = 30
            minValue = 0
            for point in range(len(limitPoint)):#限速循环
                lng1, lat1, lng2, lat2 = map(radians, [pdf["longitude"][line],pdf["latitude"][line] ,float(limitPoint[point].split(',')[0]), float(limitPoint[point].split(',')[1])])
                dlon=lng2-lng1
                dlat=lat2-lat1
                a=sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
                dis = 2 * asin(sqrt(a)) * 6371 * 1000

                if(dis < min):#不断更新最近的限速值
                    min = dis
                    minValue = float(limitPoint[point].split(',')[2])
            speedLimit.append(minValue)
        calculateResult = pd.DataFrame(speedLimit,columns=['speedLimit'])
        return pdf.assign(speedLimit=calculateResult['speedLimit'])

    # 计算每个gps记录的限速
    lines = result.select("id","longitude","latitude","altitude","time","speed","speedLimit") \
        .groupBy("id") \
        .apply(calculateSpeedLimit)
    # 计算gps超速值
    lines =lines.withColumn("overSpeed",lines['speed'] - lines['speedLimit'])

    # 筛选多余的列，方便后续操作
    result = result.select("postId","id","longitude","latitude","speed","newtime","lnewtime","distance") \
        .toDF('postId','id','longitude','latitude','speed','newtime','lnewtime','distance')

    # 将track的计算结果写入csv中，并发起查询
    query = lines \
        .writeStream \
        .outputMode("append") \
        .format("csv") \
        .option("path", "file:///D:/Carson/testdata/csvresult") \
        .option("checkpointLocation", "file:///D:/Carson/testdata/csvresult") \
        .start()

    @pandas_udf("id string,longitude double,latitude double, speed double, averageSpeed double, topSpeed double,startTime long, endTime long,brakeCount long,accelerateCount long,blackPoint long,driverDistance double", PandasUDFType.GROUPED_MAP)
    def get_quick_break_and_acceleration_count(pdf):
        # 下面的编程使用python语法，与spark api没有太大的关联，在这改变算法，不会影响spark计算逻辑
        pdf = pdf.sort_values(by=['startTime'])

        gps = pdf[['longitude','latitude']].values

        quick_acceleration_count = 0
        quick_brake_count = 0
        result_buffer = pdf.speed.values
        a = 0
        for i in range(len(result_buffer)-2):
            temp = result_buffer[i+2] - result_buffer[i]
            if temp >=14.4: #时速>=14.4
                if i-a>=4: #秒速区间大>=4
                    quick_acceleration_count = quick_acceleration_count + 1
                    a = i
            if temp <= -14.4:
                if i - a >= 4:
                    quick_brake_count = quick_brake_count + 1
                    a = i

        # pdf is a pandas.DataFrame
        speed = pdf.speed
        startTime = pdf.startTime
        endTime = pdf.endTime
        driverDistance = pdf.driverDistance

        lenth_gps = len(gps)
        traffice_black_point = ['113.407181,23.012415','113.272949,23.143769','113.304724,23.158746','113.316074,23.157255','113.327305,23.149302','113.255568,23.167771','113.303026,23.084667','113.376737,23.161029','113.321922,23.195764','113.283091,23.117287','113.382314,23.153954','113.267051,23.143433','113.275102,23.14463','113.252008,23.149623','113.322128,23.171146','113.395463,23.107858','113.312893,23.117553','113.435624,23.124154','113.395841,23.134359','113.346774,23.101626','113.387535,23.136298','113.366739,23.142964','113.356,23.165189','113.367328,23.142715','113.357276,23.162502','113.282074,23.122882','113.284785,23.124583','113.307561,23.122592','113.284774,23.133441','113.287173,23.133484','113.301506,23.137168','113.317892,23.104843','113.340005,23.108575','113.32739,23.142877','113.322908,23.137268','113.341932,23.119709','113.323385,23.104243','113.328141,23.139946','113.340551,23.145896']

        lenth_black_point = len(traffice_black_point)
        count_of_black_point = 0
        for j in range(lenth_black_point):
            for i in range(lenth_gps):
                lng1, lat1, lng2, lat2 = map(radians, [gps[i][0],gps[i][1] ,float(traffice_black_point[j].split(',')[0]), float(traffice_black_point[j].split(',')[1])])
                dlon=lng2-lng1
                dlat=lat2-lat1
                a=sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
                dis = 2 * asin(sqrt(a)) * 6371 * 1000

                if dis <20:
                    count_of_black_point = count_of_black_point + 1
                    break
        return pdf.assign(averageSpeed=speed.mean(),topSpeed=speed.max(),startTime=startTime.min(),endTime=endTime.max(),brakeCount=quick_brake_count,accelerateCount=quick_acceleration_count,blackPoint=count_of_black_point,driverDistance=driverDistance.sum())

    # 添加急加/减速等列，并通过应用自定义聚合函数统计急加速、急减速、开始/结束时间，驾驶时长等信息
    aggResult = result \
        .withColumn("averageSpeed",result['speed']) \
        .withColumn("topSpeed",result['speed']) \
        .withColumn("startTime",result['newtime']) \
        .withColumn("endTime",result['lnewtime']) \
        .withColumn("brakeCount",result['postId']) \
        .withColumn("accelerateCount",result['postId']) \
        .withColumn("blackPoint",result['postId']) \
        .withColumnRenamed("distance","driverDistance") \
        .select("id","longitude","latitude","speed","averageSpeed","topSpeed","startTime","endTime","brakeCount", "accelerateCount","blackPoint","driverDistance") \
        .groupBy("id") \
        .apply(get_quick_break_and_acceleration_count) \
        .withColumn("start",from_unixtime("startTime")) \
        .withColumn("end",from_unixtime("endTime")) \
        .dropDuplicates(["id","startTime"]) \
        .withColumn("duration",getDuration('startTime','endTime'))

    # 去掉不需要的数据 筛选出剩下的
    aggResult = aggResult.select("id","averageSpeed","topSpeed","start","end","brakeCount", "accelerateCount","blackPoint","driverDistance","duration")

    # 将结果保存到csv中，并发起查询
    query2 = aggResult \
        .writeStream \
        .outputMode("append") \
        .format("csv") \
        .option("path", "file:///D:/Carson/testdata/csvresult2") \
        .option("checkpointLocation", "file:///D:/Carson/testdata/csvresult2") \
        .start()

    try:
        # 等待程序结束
        query.awaitTermination()
        query2.awaitTermination()
    except Exception as identifier:
        print(identifier)